{% extends "base_mvp.html" %}

{% block title %}Fondos Agr√≠colas - IICA Chile{% endblock %}

{% block extra_css %}
<style>
    .hero {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        text-align: center;
    }

    .search-box {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .search-input {
        width: 100%;
        padding: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .filter-select {
        padding: 0.8rem;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
    }

    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
    }

    .stat-label {
        color: #666;
        margin-top: 0.5rem;
    }

    .fondos-grid {
        display: grid;
        gap: 1.5rem;
    }

    .fondo-card {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .fondo-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 25px rgba(102, 126, 234, 0.3);
    }

    .fondo-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .fondo-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .badge-abierto {
        background: #d4edda;
        color: #155724;
    }

    .badge-cerrado {
        background: #f8d7da;
        color: #721c24;
    }

    .fondo-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .fondo-meta {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        margin: 1rem 0;
        color: #666;
    }

    .fondo-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }

    .page-link {
        padding: 0.5rem 1rem;
        border: 2px solid #667eea;
        border-radius: 8px;
        text-decoration: none;
        color: #667eea;
        font-weight: 600;
    }

    .page-link.active {
        background: #667eea;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="hero">
    <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">üåæ Fondos de Financiamiento Agr√≠cola</h1>
    <p style="font-size: 1.2rem; opacity: 0.9;">Encuentra oportunidades de financiamiento para tu proyecto agr√≠cola</p>
</div>

<div class="stats">
    <div class="stat-card">
        <div class="stat-number">{{ stats.total_fondos }}</div>
        <div class="stat-label">Fondos Disponibles</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.fondos_abiertos }}</div>
        <div class="stat-label">Convocatorias Abiertas</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.fuentes_unicas }}</div>
        <div class="stat-label">Fuentes de Financiamiento</div>
    </div>
    <div class="stat-card">
        <div class="stat-number" style="color: #28a745;">{{ stats.monto_total }}</div>
        <div class="stat-label">Monto Total Disponible</div>
    </div>
</div>

<!-- Secci√≥n FAQ -->
<div style="max-width: 800px; margin: 4rem auto; padding: 0 1rem;">
    <h2 style="text-align: center; margin-bottom: 2rem; color: #333;">Preguntas Frecuentes</h2>
    <div style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 3px 15px rgba(0,0,0,0.1);">
        <details style="border-bottom: 1px solid #eee; padding: 1.5rem;">
            <summary style="font-weight: 600; cursor: pointer; color: #667eea; outline: none;">¬øC√≥mo puedo postular a un
                fondo?</summary>
            <p style="margin-top: 1rem; color: #555;">Selecciona el proyecto, revisa los requisitos y haz clic en
                'Postular'. Necesitar√°s tener todos los documentos listos.</p>
        </details>
        <details style="border-bottom: 1px solid #eee; padding: 1.5rem;">
            <summary style="font-weight: 600; cursor: pointer; color: #667eea; outline: none;">¬øQu√© documentos necesito?
            </summary>
            <p style="margin-top: 1rem; color: #555;">Depende del tipo de fondo. Revisa la secci√≥n 'Requisitos' de cada
                proyecto para conocer los documentos espec√≠ficos.</p>
        </details>
        <details style="border-bottom: 1px solid #eee; padding: 1.5rem;">
            <summary style="font-weight: 600; cursor: pointer; color: #667eea; outline: none;">¬øPuedo postular a varios
                fondos?</summary>
            <p style="margin-top: 1rem; color: #555;">S√≠, puedes postular a todos los fondos para los que cumplas los
                requisitos.</p>
        </details>
        <details style="padding: 1.5rem;">
            <summary style="font-weight: 600; cursor: pointer; color: #667eea; outline: none;">¬øQuanto demora la
                revisi√≥n?</summary>
            <p style="margin-top: 1rem; color: #555;">El tiempo var√≠a seg√∫n la instituci√≥n. Generalmente entre 30 y 90
                d√≠as desde el cierre de la convocatoria.</p>
        </details>
    </div>
</div>

<div class="search-box">
    <form method="GET" action="{{ url_for('home') }}">
        <input type="text" name="q" class="search-input"
            placeholder="üîç Buscar por nombre, descripci√≥n o palabras clave..." value="{{ query }}" id="searchInput">

        <div class="filters">
            <select name="fuente" class="filter-select">
                <option value="">Todas las fuentes</option>
                <option value="INDAP" {% if fuente=='INDAP' %}selected{% endif %}>INDAP</option>
                <option value="FIA" {% if fuente=='FIA' %}selected{% endif %}>FIA</option>
                <option value="CORFO" {% if fuente=='CORFO' %}selected{% endif %}>CORFO</option>
                <option value="FONTAGRO" {% if fuente=='FONTAGRO' %}selected{% endif %}>FONTAGRO</option>
            </select>

            <select name="area" class="filter-select">
                <option value="">Todas las √°reas</option>
                <option value="Agricultura" {% if area=='Agricultura' %}selected{% endif %}>Agricultura</option>
                <option value="Innovaci√≥n" {% if area=='Innovaci√≥n' %}selected{% endif %}>Innovaci√≥n</option>
                <option value="Medio Ambiente" {% if area=='Medio Ambiente' %}selected{% endif %}>Medio Ambiente
                </option>
                <option value="Infraestructura" {% if area=='Infraestructura' %}selected{% endif %}>Infraestructura
                </option>
            </select>

            <select name="estado" class="filter-select">
                <option value="">Todos los estados</option>
                <option value="Abierto" {% if estado=='Abierto' %}selected{% endif %}>Abierto</option>
                <option value="Pr√≥ximamente" {% if estado=='Pr√≥ximamente' %}selected{% endif %}>Pr√≥ximamente</option>
                <option value="Cerrado" {% if estado=='Cerrado' %}selected{% endif %}>Cerrado</option>
            </select>

            <button type="submit" class="btn btn-primary" style="padding: 0.8rem 1.5rem;">
                Buscar
            </button>
        </div>
    </form>
</div>

<div class="fondos-grid">
    {% if fondos.items %}
    {% for fondo in fondos.items %}
    <div class="fondo-card">
        <div class="fondo-header">
            <div style="flex: 1;">
                <h3 class="fondo-title">{{ fondo.nombre }}</h3>
                <div style="color: #667eea; font-weight: 600;">{{ fondo.fuente }}</div>
            </div>
            <span class="fondo-badge {% if fondo.estado == 'Abierto' %}badge-abierto{% else %}badge-cerrado{% endif %}">
                {{ fondo.estado }}
            </span>
        </div>

        <p style="color: #666; margin: 1rem 0;">
            {{ fondo.descripcion[:200] }}{% if fondo.descripcion|length > 200 %}...{% endif %}
        </p>

        <div class="fondo-meta">
            <div class="fondo-meta-item">
                <span>üí∞</span>
                <span>{{ fondo.monto_texto or 'Consultar bases' }}</span>
            </div>
            {% if fondo.fecha_cierre %}
            <div class="fondo-meta-item">
                <span>üìÖ</span>
                <span>Cierra: {{ fondo.fecha_cierre.strftime('%d/%m/%Y') }}</span>
            </div>
            {% endif %}
            <div class="fondo-meta-item">
                <span>üè∑Ô∏è</span>
                <span>{{ fondo.area_interes }}</span>
            </div>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <a href="{{ url_for('detalle_fondo', id=fondo.id) }}" class="btn btn-primary"
                style="flex: 1; text-align: center;">
                Ver Detalles
            </a>
            {% if current_user.is_authenticated %}
            <button onclick="toggleFavorito({{ fondo.id }})" class="btn btn-secondary">
                ‚≠ê
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div style="text-align: center; padding: 3rem; background: white; border-radius: 15px;">
        <p style="font-size: 1.2rem; color: #666;">No se encontraron fondos con los criterios seleccionados.</p>
        <a href="{{ url_for('home') }}" class="btn btn-primary" style="margin-top: 1rem;">Ver todos los fondos</a>
    </div>
    {% endif %}
</div>

{% if fondos.pages > 1 %}
<div class="pagination">
    {% if fondos.has_prev %}
    <a href="{{ url_for('home', page=fondos.prev_num, q=query, fuente=fuente, area=area, estado=estado) }}"
        class="page-link">‚Üê Anterior</a>
    {% endif %}

    {% for page_num in fondos.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
    {% if page_num %}
    <a href="{{ url_for('home', page=page_num, q=query, fuente=fuente, area=area, estado=estado) }}"
        class="page-link {% if page_num == fondos.page %}active{% endif %}">
        {{ page_num }}
    </a>
    {% else %}
    <span class="page-link">...</span>
    {% endif %}
    {% endfor %}

    {% if fondos.has_next %}
    <a href="{{ url_for('home', page=fondos.next_num, q=query, fuente=fuente, area=area, estado=estado) }}"
        class="page-link">Siguiente ‚Üí</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // B√∫squeda en tiempo real (opcional)
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;

    searchInput.addEventListener('input', function () {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            // Aqu√≠ se puede implementar b√∫squeda AJAX en el futuro
            console.log('Buscando:', this.value);
        }, 500);
    });

    // Toggle favorito
    function toggleFavorito(fondoId) {
        fetch(`/api/favorito/toggle/${fondoId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                location.reload();
            })
            .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}