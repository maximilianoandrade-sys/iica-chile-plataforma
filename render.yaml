services:
  - type: web
    name: plataforma-iica-proyectos
    env: python
    # FORZAR LIMPIEZA DE CACHÉ: Actualizar pip y dependencias antes de instalar
    # El flag --no-cache-dir ayuda a evitar caché de pip
    buildCommand: python -m pip install --upgrade pip setuptools wheel && python -m pip install --no-cache-dir -r requirements.txt
    # CRÍTICO: Sin --preload para evitar caché, con max-requests bajo para forzar reinicios
    # NOTA: Usamos app:app porque app.py importa desde app_enhanced.py
    # SIN --preload para asegurar que se cargue código fresco en cada worker
    startCommand: gunicorn app:app --bind 0.0.0.0:$PORT --workers 2 --timeout 300 --max-requests 50 --max-requests-jitter 10 --graceful-timeout 30
    pythonVersion: 3.11.9
    # Forzar rebuild sin caché en cada deploy
    autoDeploy: true
    # Variables de entorno optimizadas
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.9
      - key: PORT
        value: 10000
      - key: DEBUG
        value: "False"
      - key: FLASK_ENV
        value: "production"
      - key: GOOGLE_API_KEY
        fromSecret: GOOGLE_API_KEY
      - key: GOOGLE_CX
        fromSecret: GOOGLE_CX
    # Health check para monitoreo
    healthCheckPath: /health
